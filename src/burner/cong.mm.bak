// Burner Config for Game file module
#include "burner.h"
#include "neocdlist.h"
#include <cstring>

// Define macOS compatibility functions for Windows text functions
#define _stprintf sprintf
#define _tfopen fopen
#define _fgetts fgets
#define _tcslen strlen
#define _tcstol strtol
#define _ftprintf fprintf
#define _T(x) x

// Define szAppBurnVer for Metal build
#ifndef szAppBurnVer
#define szAppBurnVer "1.0.0"
#endif

const INT32 nConfigMinVersion = 0x020921;

bool bSaveInputs = true;

static TCHAR* GameConfigName()
{
	static TCHAR szName[MAX_PATH];

	#if defined(BUILD_SDL2) && !defined(SDL_WINDOWS)
		if (NeoCDInfo_ID()) {
		  _stprintf(szName, "%sngcd_%s.ini", szAppEEPROMPath, BurnDrvGetText(DRV_NAME));
		} else {
			_stprintf(szName, "%s%s.ini", szAppEEPROMPath, BurnDrvGetText(DRV_NAME));
		}
	#else
		// Return the path of the config file for this game
		if (NeoCDInfo_ID()) {
			_stprintf(szName, "config/games/ngcd_%s.ini", NeoCDInfo_Text(DRV_NAME));
		} else {
			_stprintf(szName, "config/games/%s.ini", BurnDrvGetText(DRV_NAME));
		}
	#endif
	return szName;
}

// Read in the config file for the game-specific inputs
INT32 ConfigGameLoad(bool bOverWrite)
{
	TCHAR szLine[256];
	INT32 nFileVersion = 0;

	FILE* h = _tfopen(GameConfigName(), "rt");
	if (h == NULL) {
		// Not command line start, always -1
		if (-1 == nSubDrvSelected) return 1;

		// Command line to start a subgame - game configuration not found
		h = _tfopen(GameConfigName(), "wt");	// Create
		if (h == NULL) return 1;

		ConfigGameSave(true);						// Write default configuration and save
		fclose(h);

		h = _tfopen(GameConfigName(), "rt");	// Reopen
		if (h == NULL) return 1;
	}

	if (bOverWrite) {
		nAnalogSpeed = 0x0100;
		nBurnCPUSpeedAdjust = 0x0100;
	}

	// Go through each line of the config file and process inputs
	while (_fgetts(szLine, 256, h)) {
		TCHAR *szValue;
		INT32 nLen = _tcslen(szLine);

		// Get rid of the linefeed and carriage return at the end
		if (nLen > 0 && szLine[nLen - 1] == 10) {
			szLine[nLen - 1] = 0;
			nLen--;
		}
		if (nLen > 0 && szLine[nLen - 1] == 13)
		{
			szLine[nLen - 1] = 0;
			nLen--;
		}

		szValue = LabelCheck(szLine, "version");
		if (szValue) {
			nFileVersion = _tcstol(szValue, NULL, 0);
		}

		if (bOverWrite) {
			szValue = LabelCheck(szLine, "analog");
			if (szValue) {
				nAnalogSpeed = _tcstol(szValue, NULL, 0);
			}
			szValue = LabelCheck(szLine, "cpu");
			if (szValue) {
				nBurnCPUSpeedAdjust = _tcstol(szValue, NULL, 0);
			}
		}

		if (nConfigMinVersion <= nFileVersion && nFileVersion <= nBurnVer) {
			szValue = LabelCheck(szLine, "input");
			if (szValue) {
				GameInpRead(szValue, bOverWrite);
				continue;
			}

			szValue = LabelCheck(szLine, "macro");
			if (szValue) {
				GameInpMacroRead(szValue, bOverWrite);
				continue;
			}

			szValue = LabelCheck(szLine, "afire");
			if (szValue) {
				GameMacroAutofireRead(szValue, bOverWrite);
				continue;
			}

			szValue = LabelCheck(szLine, "custom");
			if (szValue) {
				GameInpCustomRead(szValue, bOverWrite);
				continue;
			}
		}
	}

	fclose(h);
	return 0;
}

// Define a simple ANSIToTCHAR replacement for macOS
static char* ANSIToTCHAR(const char* str, char* buffer, int size) {
    static char staticBuffer[1024];
    if (str == NULL) return NULL;
    if (buffer == NULL) {
        strncpy(staticBuffer, str, 1023);
        staticBuffer[1023] = 0;
        return staticBuffer;
    } else {
        strncpy(buffer, str, size - 1);
        buffer[size - 1] = 0;
        return buffer;
    }
}

// Write out the config file for the game-specific inputs
INT32 ConfigGameSave(bool bSave)
{
	FILE* h;

	if (!bSave) {
		GameInpBlank(0);
		ConfigGameLoad(false);
	}

	h = _tfopen(GameConfigName(), "wt");
	if (h == NULL) {
		return 1;
	}

	// Write title
	_ftprintf(h, "// " APP_TITLE " v%s --- Config File for %s (%s)\n\n", szAppBurnVer, BurnDrvGetText(DRV_NAME), ANSIToTCHAR(BurnDrvGetTextA(DRV_FULLNAME), NULL, 0));

	_ftprintf(h, "// --- Miscellaneous ----------------------------------------------------------\n\n");
	// Write version number
	_ftprintf(h, "version 0x%06X\n\n", nBurnVer);
	// Write speed for relative analog controls
	_ftprintf(h, "analog  0x%04X\n", nAnalogSpeed);
	// Write CPU speed adjustment
	_ftprintf(h, "cpu     0x%04X\n", nBurnCPUSpeedAdjust);

	_ftprintf(h, "\n\n\n");
	_ftprintf(h, "// --- Inputs -----------------------------------------------------------------\n\n");

	GameInpWrite(h);

	fclose(h);
	return 0;
}
